#!/bin/sh

# Secret detection - prevent accidental commits of API keys and secrets
echo "üîç Checking for secrets in staged files..."

# Check for common secret patterns in staged files (pk_test_ excluded as they're safe publishable keys)
SECRET_PATTERNS='(sk_live_[a-zA-Z0-9]{20,}|sk_test_[a-zA-Z0-9]{20,}|pk_live_[a-zA-Z0-9]{20,}|whsec_[a-zA-Z0-9]{20,}|secret_[a-zA-Z0-9]{20,}|api_key_[a-zA-Z0-9]{20,})'

# Get staged files and check for secrets
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -n "$STAGED_FILES" ]; then
  # Check for actual secrets (not placeholders or examples)
  FOUND_SECRETS=$(echo "$STAGED_FILES" | xargs -I {} git diff --cached {} | \
    grep -E "$SECRET_PATTERNS" | \
    grep -v -E "(YOUR_|PLACEHOLDER|EXAMPLE|<.*>|\.example|example\.)" || true)
  
  if [ -n "$FOUND_SECRETS" ]; then
    echo "‚ùå SECURITY ALERT: Potential secrets detected in commit!"
    echo ""
    echo "Found the following suspicious patterns:"
    echo "$FOUND_SECRETS" | head -5
    echo ""
    echo "Please remove actual secrets and use placeholders like:"
    echo "  - <WEBHOOK_SECRET> or whsec_YOUR_SECRET_HERE"
    echo "  - pk_live_YOUR_KEY_HERE"
    echo "  - sk_live_YOUR_SECRET_HERE"
    echo ""
    echo "If these are false positives (examples/placeholders), please review carefully."
    exit 1
  fi
fi

echo "‚úÖ No secrets detected in staged files"

# Design system enforcement - prevent primitive token usage
echo "üé® Checking for primitive token usage in staged files..."

# Get staged TypeScript/TSX files (exclude docs and test files from enforcement)
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | \
  grep -E '\.(ts|tsx)$' | \
  grep -v -E '(globals\.css|\.md$|__tests__|\.test\.)' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  # Check for primitive token patterns in ADDED lines only (not removals)
  # This allows migration commits that remove primitive tokens
  PRIMITIVE_TOKENS=$(echo "$STAGED_TS_FILES" | xargs -I {} git diff --cached {} | \
    grep '^+' | \
    grep -E '\b(text|bg|border)-(ink|parchment)-[0-9]+\b' | \
    grep -v 'mode-' || true)

  if [ -n "$PRIMITIVE_TOKENS" ]; then
    echo "‚ùå DESIGN SYSTEM VIOLATION: Primitive tokens detected!"
    echo ""
    echo "Found the following primitive token usage:"
    echo "$PRIMITIVE_TOKENS" | head -10
    echo ""
    echo "Use semantic tokens instead:"
    echo "  - text-ink-900 ‚Üí text-primary"
    echo "  - text-ink-700 ‚Üí text-secondary"
    echo "  - text-ink-500 ‚Üí text-tertiary"
    echo "  - bg-parchment-50 ‚Üí bg-surface-elevated"
    echo "  - border-parchment-300 ‚Üí border-outline-default"
    echo ""
    echo "See DESIGN_SYSTEM.md for full token reference."
    exit 1
  fi
fi

echo "‚úÖ No primitive tokens detected in staged files"

# Run lint-staged as before
npx lint-staged
